<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt d·ª± √°n - TEAManage</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/project-details.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <!-- Custom CSS for add members modal -->
    <link rel="stylesheet" href="/css/add-members-modal.css">
    
</head>
<body>
    <!-- Top Navbar -->
    <nav class="top-navbar">
        <div class="navbar-content">
            <div class="d-flex align-items-center gap-3">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <a href="index.html" class="navbar-brand">
                    <img src="images/team-logo.svg" alt="TEAManage Logo" class="logo-image">
                    TEAManage
                </a>
            </div>
            
            <!-- User & Notification Menu -->
            <div class="d-flex align-items-center gap-3">
                <!-- Notifications -->
                <div class="dropdown">
                    <button class="navbar-btn notification-badge" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-bell"></i>
                        <span class="notification-count" style="display: none;">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown">
                        <div class="notification-header">
                            <h6 class="mb-0">Th√¥ng b√°o</h6>
                            <button class="btn btn-sm btn-link mark-all-read-btn" type="button">
                                ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                            </button>
                        </div>
                        <div class="notification-list">
                            <div class="loading-notifications">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="dropdown">
                    <button class="icon-btn" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                        <span class="user-name" id="userDisplayName">User</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <div class="dropdown-header">
                            <strong id="userDisplayNameDropdown">User Name</strong>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="profile.html">
                            <i class="bi bi-person me-2"></i>H·ªì s∆°
                        </a>
                        <a class="dropdown-item" href="profile.html">
                            <i class="bi bi-gear me-2"></i>C√†i ƒë·∫∑t
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>ƒêƒÉng xu·∫•t
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Project Header -->
            <div class="project-header">
                <div class="project-info">
                    <div class="project-title-section">
                        <h1 class="project-title" id="projectName">ƒêang t·∫£i...</h1>
                        <p class="project-description" id="projectDescription">ƒêang t·∫£i m√¥ t·∫£ d·ª± √°n...</p>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-primary" onclick="createTask()">
                            <i class="bi bi-plus-lg me-2"></i>T·∫°o nhi·ªám v·ª•
                        </button>
                        <button class="btn btn-outline-primary" onclick="inviteMember()">
                            <i class="bi bi-person-plus me-2"></i>M·ªùi th√†nh vi√™n
                        </button>
                    </div>
                </div>
                
                <div class="project-meta">
                    <div class="meta-item">
                        <span class="meta-label">Tr·∫°ng th√°i</span>
                        <span class="meta-value status-badge" id="projectStatus">ƒêang t·∫£i...</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Ng√†y b·∫Øt ƒë·∫ßu</span>
                        <span class="meta-value" id="projectStartDate">--</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Ng√†y k·∫øt th√∫c</span>
                        <span class="meta-value" id="projectEndDate">--</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Ti·∫øn ƒë·ªô</span>
                        <div class="progress-container">
                            <div class="progress">
                                <div class="progress-bar" id="projectProgressBar" style="width: 0%"></div>
                            </div>
                            <span class="progress-text" id="projectProgressText">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs-container">
                <div class="nav nav-tabs">
                    <button class="nav-link tab-btn active" onclick="showTab('tasks')">
                        <i class="bi bi-list-check me-2"></i>Nhi·ªám v·ª•
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('members')">
                        <i class="bi bi-people me-2"></i>Th√†nh vi√™n
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('files')">
                        <i class="bi bi-folder me-2"></i>T·ªáp tin
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('activity')">
                        <i class="bi bi-activity me-2"></i>Ho·∫°t ƒë·ªông
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('settings')" id="settingsTabBtn" style="display: none;">
                        <i class="bi bi-gear me-2"></i>C√†i ƒë·∫∑t
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Tasks Tab -->
                <div class="tab-pane active" id="tasksTab">
                    <div class="tasks-container">
                        <div class="tasks-header">
                            <h4>Danh s√°ch nhi·ªám v·ª•</h4>
                            <button class="btn btn-primary btn-sm" onclick="createTask()">
                                <i class="bi bi-plus me-1"></i>T·∫°o nhi·ªám v·ª•
                            </button>
                        </div>
                        <div class="tasks-list" id="tasksList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div class="tab-pane" id="membersTab">
                    <div class="members-container">
                        <div class="members-header">
                            <h4>Th√†nh vi√™n d·ª± √°n</h4>
                                            <button class="btn btn-primary btn-sm" id="openAddMembersModalBtn" style="display: none;">+ Th√™m th√†nh vi√™n</button>
                        </div>
                        <div class="members-list" id="membersList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </div>
                        </div>
                                    <!-- Add Members Modal (Reusable)-->
                                    <div class="modal fade add-members-modal" id="addMembersModal" tabindex="-1" aria-labelledby="addMembersModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form id="addMembersForm" autocomplete="off">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="addMembersModalLabel">Th√™m th√†nh vi√™n v√†o d·ª± √°n</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3 position-relative">
                                                            <label for="addMembersInput" class="form-label">Nh·∫≠p email th√†nh vi√™n</label>
                                                            <input type="text" class="form-control" id="addMembersInput" placeholder="Nh·∫≠p email..." autocomplete="off">
                                                            <div class="suggestion-dropdown" id="addMembersDropdown"></div>
                                                        </div>
                                                        <div class="selected-members-list" id="selectedMembersList"></div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                                                        <button type="submit" class="btn btn-success" id="addMembersSubmitBtn">Th√™m th√†nh vi√™n</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                    </div>
                </div>

                <!-- Files Tab -->
                <div class="tab-pane" id="filesTab">
                    <div class="files-container">
                        <div class="files-header">
                            <h4>T·ªáp tin d·ª± √°n</h4>
                            <button class="btn btn-primary btn-sm" onclick="uploadFile()">
                                <i class="bi bi-upload me-1"></i>T·∫£i l√™n
                            </button>
                        </div>
                        <div class="files-list" id="filesList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-pane" id="activityTab">
                    <div class="activity-container">
                        <h4>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h4>
                        <div class="activity-list" id="activityList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane" id="settingsTab">
                    <div class="settings-container">
                        <h4>C√†i ƒë·∫∑t d·ª± √°n</h4>
                        <div class="settings-section">
                            <h5>Qu·∫£n l√Ω d·ª± √°n</h5>
                            <div class="d-grid gap-2 d-md-block">
                                <button class="btn btn-outline-primary" onclick="editProject()">
                                    <i class="bi bi-pencil me-2"></i>Ch·ªânh s·ª≠a d·ª± √°n
                                </button>
                                <button class="btn btn-outline-success" id="exportReportBtn" type="button">
                                    <i class="bi bi-file-earmark-arrow-down me-2"></i>Xu·∫•t b√°o c√°o d·ª± √°n
                                </button>
                                <div id="exportReportOptions" class="dropdown-menu" style="min-width:180px;">
                                    <button class="dropdown-item" id="exportPdfBtn" type="button"><i class="bi bi-file-earmark-pdf me-2 text-danger"></i>Xu·∫•t PDF</button>
                                    <button class="dropdown-item" id="exportExcelBtn" type="button"><i class="bi bi-file-earmark-excel me-2 text-success"></i>Xu·∫•t Excel</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5 class="text-danger">V√πng nguy hi·ªÉm</h5>
                            <button class="btn btn-outline-danger" onclick="deleteProject()">
                                <i class="bi bi-trash me-2"></i>X√≥a d·ª± √°n
                            </button>
                        </div>

                        <div class="settings-section">
                            <h5>C·∫≠p nh·∫≠t tr·∫°ng th√°i d·ª± √°n</h5>
                            <form id="projectStatusForm" class="row g-2 align-items-center" autocomplete="off">
                                <div class="col-auto">
                                    <select class="form-select" id="editProjectStatus" name="status" required>
                                        <option value="ACTIVE">ƒêang ho·∫°t ƒë·ªông</option>
                                        <option value="COMPLETED">ƒê√£ ho√†n th√†nh</option>
                                        <option value="ON_HOLD">T·∫°m d·ª´ng</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary">L∆∞u tr·∫°ng th√°i</button>
                                </div>
                                <div class="col-12">
                                    <div id="projectStatusAlert" class="alert mt-2 d-none" role="alert"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Options Modal -->
    <div class="modal fade" id="memberOptionsModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">T√πy ch·ªçn th√†nh vi√™n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="promoteViceBtn" onclick="promoteTo('VICE_LEADER')">
                            <i class="bi bi-arrow-up me-2"></i>N√¢ng l√™n Ph√≥ nh√≥m
                        </button>
                        <button class="btn btn-outline-primary btn-sm" id="promoteLeaderBtn" onclick="promoteTo('LEADER')">
                            <i class="bi bi-crown me-2"></i>N√¢ng l√™n Tr∆∞·ªüng nh√≥m
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="removeBtn" onclick="removeMember()">
                            <i class="bi bi-person-dash me-2"></i>X√≥a kh·ªèi d·ª± √°n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Code Modal -->
    <div class="modal fade" id="inviteCodeModal" tabindex="-1" aria-labelledby="inviteCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: #764BA2; color: white;">
                    <h5 class="modal-title" id="inviteCodeModalLabel">
                        <i class="bi bi-link-45deg me-2"></i>M√£ m·ªùi tham gia nh√≥m
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Chia s·∫ª m√£ n√†y ƒë·ªÉ m·ªùi ng∆∞·ªùi kh√°c tham gia d·ª± √°n:</p>
                    <div class="invite-code-container">
                        <div class="input-group">
                            <input type="text" class="form-control" id="inviteCodeInput" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="copyInviteCode(event)">
                                <i class="bi bi-clipboard me-1"></i>Copy
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            M√£ n√†y c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ tham gia d·ª± √°n. Ch·ªâ chia s·∫ª v·ªõi nh·ªØng ng∆∞·ªùi b·∫°n tin t∆∞·ªüng.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="generateNewCode()">
                        <i class="bi bi-arrow-clockwise me-1"></i>T·∫°o m√£ m·ªõi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- Utility Scripts -->
    <script src="/utils/auth-utils.js"></script>
    <script src="/utils/api-client.js"></script>
    <script src="/utils/ui-utils.js"></script>
    
    <!-- Notifications Service -->
    <script src="/js/notifications.js"></script>s
    
    <!-- Main Script -->
    <script src="/js/project-details.js"></script>
    <script src="/js/add-members-modal.js"></script>
    
    <script>
    // --- Export Project Report Logic ---
    const exportBtn = document.getElementById('exportReportBtn');
    const exportOptions = document.getElementById('exportReportOptions');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');

    // Hi·ªán menu ch·ªçn lo·∫°i file khi b·∫•m n√∫t xu·∫•t
    exportBtn.addEventListener('click', function(e) {
        exportOptions.classList.toggle('show');
        const rect = exportBtn.getBoundingClientRect();
        exportOptions.style.position = 'absolute';
        exportOptions.style.left = rect.left + 'px';
        exportOptions.style.top = (rect.bottom + window.scrollY) + 'px';
    });
    // ·∫®n menu khi click ngo√†i
    document.addEventListener('click', function(e) {
        if (!exportBtn.contains(e.target) && !exportOptions.contains(e.target)) {
            exportOptions.classList.remove('show');
        }
    });

    function getProjectIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    async function exportProjectReport(type) {
        const projectId = getProjectIdFromUrl();
        if (!projectId) return;
        const baseApi = "http://localhost:8080"; // Ho·∫∑c l·∫•y t·ª´ bi·∫øn to√†n c·ª•c n·∫øu c√≥
        let genUrl = '', fileType = '';
        if (type === 'pdf') {
            genUrl = `${baseApi}/api/reports/projects/${projectId}/pdf`;
            fileType = 'pdf';
        } else {
            genUrl = `${baseApi}/api/reports/projects/${projectId}/excel`;
            fileType = 'excel';
        }
        // L·∫•y headers (Authorization n·∫øu c√≥)
        let headers = {};
        if (typeof authUtils !== 'undefined' && authUtils.isAuthenticated()) {
            headers = authUtils.getAuthHeader();
        }
        try {
            // G·ª≠i request t·∫°o file
            const res = await fetch(genUrl, { method: 'POST', headers });
            if (!res.ok) {
                const errText = await res.text();
                throw new Error('L·ªói t·∫°o file: ' + errText);
            }
            const data = await res.json();
            if (!data.path) throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ƒë∆∞·ªùng d·∫´n file');
            // G·ª≠i request t·∫£i file
            let downloadEndpoint = fileType === 'pdf' ? `${baseApi}/api/reports/download/pdf` : `${baseApi}/api/reports/download`;
            const downloadRes = await fetch(`${downloadEndpoint}?path=${encodeURIComponent(data.path)}`, { headers });
            if (!downloadRes.ok) {
                const errText = await downloadRes.text();
                throw new Error('L·ªói t·∫£i file: ' + errText);
            }
            const blob = await downloadRes.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileType === 'pdf' ? 'report.pdf' : 'report.xlsx';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                a.remove();
            }, 1000);
        } catch (err) {
            alert('L·ªói xu·∫•t b√°o c√°o: ' + (err.message || err));
        }
    }

    exportPdfBtn.addEventListener('click', function() {
        exportOptions.classList.remove('show');
        exportProjectReport('pdf');
    });
    exportExcelBtn.addEventListener('click', function() {
        exportOptions.classList.remove('show');
        exportProjectReport('excel');
    });
        // Debug: Track page load events
        console.log('üèÅ PAGE LOAD: project-details.html loaded at', new Date().toISOString());
        
        // Track when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã DOM READY: project-details.html DOM ready at', new Date().toISOString());
        });
        
        // Track beforeunload to detect page refresh/navigation
        window.addEventListener('beforeunload', function(event) {
            console.log('üîÑ BEFORE UNLOAD: Page is about to unload/refresh at', new Date().toISOString());
            console.log('üîÑ BEFORE UNLOAD: Current URL:', window.location.href);
        });
        
        // Track page visibility changes
        document.addEventListener('visibilitychange', function() {
            console.log('üëÅÔ∏è VISIBILITY CHANGE: Page visibility changed to', document.visibilityState);
        });
    </script>
    <script>
        // N√∫t chuy·ªÉn sang trang t·∫°o nhi·ªám v·ª•, truy·ªÅn projectId
        function createTask() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            if (projectId) {
                window.location.href = `task-create.html?projectId=${projectId}`;
            } else {
                window.location.href = 'task-create.html';
            }
        }
    </script>
</body>
</html>
