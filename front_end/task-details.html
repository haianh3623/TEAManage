<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết nhiệm vụ - TEAManage</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/task-details.css" rel="stylesheet">
</head>
<body>
    <!-- Top Navbar -->
    <nav class="top-navbar">
        <div class="navbar-content">
            <div class="d-flex align-items-center gap-3">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <a href="index.html" class="navbar-brand">
                    <img src="images/team-logo.svg" alt="TEAManage Logo" class="logo-image">
                    TEAManage
                </a>
            </div>
            
            <!-- User & Notification Menu -->
            <div class="d-flex align-items-center gap-3">
                <!-- Notifications -->
                <div class="dropdown">
                    <button class="icon-btn" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown">
                        <div class="dropdown-header d-flex justify-content-between align-items-center">
                            <span>Thông báo</span>
                            <button class="btn btn-sm btn-link p-0" onclick="markAllAsRead()">Đánh dấu đã đọc</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="dropdown-item-text text-muted text-center py-3">
                                Đang tải thông báo...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Menu -->
                <div class="dropdown">
                    <button class="icon-btn" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                        <span class="user-name" id="userDisplayName">User</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <div class="dropdown-header">
                            <strong id="userDisplayNameDropdown">User Name</strong>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="profile.html">
                            <i class="bi bi-person me-2"></i>Hồ sơ
                        </a>
                        <a class="dropdown-item" href="profile.html">
                            <i class="bi bi-gear me-2"></i>Cài đặt
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Task Header -->
            <div class="task-header">
                <div class="task-info">
                    <div class="task-title-section">
                        <h1 class="task-title" id="taskTitle">Đang tải...</h1>
                        <p class="task-description" id="taskDescription">Đang tải mô tả nhiệm vụ...</p>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="editTask()" id="editTaskBtn" style="display: none;">
                            <i class="bi bi-pencil me-2"></i>Chỉnh sửa
                        </button>
                        <button class="btn btn-outline-primary" onclick="createSubTask()">
                            <i class="bi bi-plus-lg me-2"></i>Tạo nhiệm vụ con
                        </button>
                        <button class="btn btn-success" onclick="showSubmitTaskModal()" id="submitTaskBtn">
                            <i class="bi bi-upload me-2"></i>Submit nhiệm vụ
                        </button>
                    </div>
                </div>
                
                <div class="task-meta">
                    <div class="meta-row">
                        <div class="meta-item">
                            <span class="meta-label">Trạng thái</span>
                            <span class="meta-value status-badge" id="taskStatus">Đang tải...</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Độ ưu tiên</span>
                            <span class="meta-value priority-badge" id="taskPriority">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Deadline</span>
                            <span class="meta-value" id="taskDeadline">--</span>
                        </div>
                    </div>
                    <div class="meta-row">
                        <div class="meta-item">
                            <span class="meta-label">Người tạo</span>
                            <span class="meta-value" id="taskCreator">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Dự án</span>
                            <span class="meta-value" id="taskProject">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Tiến độ</span>
                            <div class="progress-container">
                                <div class="progress">
                                    <div class="progress-bar" id="taskProgressBar" style="width: 0%"></div>
                                </div>
                                <span class="progress-text" id="taskProgressText">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs-container">
                <div class="nav nav-tabs">
                    <button class="nav-link tab-btn active" onclick="showTab('hierarchy')">
                        <i class="bi bi-diagram-3 me-2"></i>Hệ nhiệm vụ
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('assignees')">
                        <i class="bi bi-people me-2"></i>Thành viên được giao
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('files')">
                        <i class="bi bi-paperclip me-2"></i>File đính kèm
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('activity')">
                        <i class="bi bi-activity me-2"></i>Hoạt động
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('submissions')" id="submissionsTabBtn">
                        <i class="bi bi-send-check me-2"></i>Submissions
                    </button>
                    <button class="nav-link tab-btn" onclick="showTab('settings')" id="settingsTabBtn" style="display: none;">
                        <i class="bi bi-gear me-2"></i>Cài đặt
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
                <!-- Submissions Tab -->
                <div class="tab-pane" id="submissionsTab">
                    <div class="submissions-container">
                        <div class="submissions-header">
                            <h4>Danh sách submissions</h4>
                        </div>
                        <div class="submissions-content" id="submissionsContent">
                            <div class="loading-spinner text-center py-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải submissions...</p>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Submission Log Modal -->
        <div class="modal fade" id="submissionLogModal" tabindex="-1" aria-labelledby="submissionLogModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="submissionLogModalLabel">Chi tiết Submission</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="submissionLogModalBody">
                        <!-- Nội dung log sẽ được render ở đây -->
                    </div>
                    <div class="modal-footer" id="submissionLogModalFooter">
                    </div>
                </div>
            </div>
        </div>
            <div class="tab-content">
                <!-- Task Hierarchy Tab -->
                <div class="tab-pane active" id="hierarchyTab">
                    <div class="hierarchy-container">
                        <div class="hierarchy-header">
                            <h4>Hệ thống nhiệm vụ</h4>
                            <div class="hierarchy-controls">
                                <button class="btn btn-outline-secondary btn-sm" onclick="expandAllTasks()">
                                    <i class="bi bi-arrows-expand"></i> Mở rộng tất cả
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="collapseAllTasks()">
                                    <i class="bi bi-arrows-collapse"></i> Thu gọn tất cả
                                </button>
                            </div>
                        </div>
                        <div class="hierarchy-content" id="hierarchyContent">
                            <div class="loading-spinner text-center py-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải hệ thống nhiệm vụ...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assignees Tab -->
                <div class="tab-pane" id="assigneesTab">
                    <div class="assignees-container">
                        <div class="assignees-header">
                            <h4>Thành viên được giao nhiệm vụ</h4>
                            <button class="btn btn-primary btn-sm" onclick="showAssignMemberModal()" id="assignMemberBtn" style="display: none;">
                                <i class="bi bi-person-plus me-2"></i>Giao cho thành viên
                            </button>
                        </div>
        <!-- Assign Member Modal -->
        <div class="modal fade" id="assignMemberModal" tabindex="-1" aria-labelledby="assignMemberModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="assignMemberForm" autocomplete="off">
                        <div class="modal-header">
                            <h5 class="modal-title" id="assignMemberModalLabel">Giao nhiệm vụ cho thành viên</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3 position-relative">
                                <label for="assignMemberInput" class="form-label">Tìm kiếm thành viên dự án</label>
                                <input type="text" class="form-control" id="assignMemberInput" placeholder="Nhập tên hoặc email để tìm kiếm..." autocomplete="off">
                                <div class="form-text mb-2">Chỉ có thể giao cho thành viên đã tham gia dự án.</div>
                                <div class="suggestion-dropdown styled-suggestion" id="assignMemberDropdown"></div>
                            </div>
                            <div class="selected-members-list styled-selected-list" id="selectedAssigneesList"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-success" id="assignMemberSubmitBtn">Giao nhiệm vụ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <style>
        /* Modal Assign Member UI improvements */
        #assignMemberModal .modal-content { border-radius: 14px; }
        #assignMemberModal .modal-header { border-bottom: 1px solid #f0f0f0; }
        #assignMemberModal .modal-title { font-weight: 600; }
        #assignMemberInput { border-radius: 8px; }
        .styled-suggestion { max-height: 220px; overflow-y: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid #e9ecef; margin-top: 2px; }
        .assign-member-suggestion { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .assign-member-suggestion:hover { background: #f5f7fa; }
        .assign-member-avatar { width: 32px; height: 32px; border-radius: 50%; background: #e0e7ef; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4a4a4a; font-size: 1.1rem; margin-right: 6px; }
        .assign-member-info { flex: 1; min-width: 0; }
        .assign-member-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .assign-member-email { font-size: 0.95em; color: #888; }
        .assign-member-role { font-size: 0.92em; color: #6c757d; margin-left: 4px; }
        .styled-selected-list { margin-top: 10px; }
        .selected-member-item { display: flex; align-items: center; gap: 10px; background: #f8fafc; border-radius: 7px; padding: 7px 12px; margin-bottom: 7px; border: 1px solid #e9ecef; }
        .selected-member-avatar { width: 28px; height: 28px; border-radius: 50%; background: #b6d0fa; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #2a2a2a; font-size: 1rem; }
        .selected-member-info { flex: 1; min-width: 0; }
        .selected-member-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .selected-member-email { font-size: 0.95em; color: #888; }
        .selected-member-role { font-size: 0.92em; color: #6c757d; margin-left: 4px; }
        .selected-member-item .btn-link { color: #dc3545; font-size: 1.1em; }
        @media (max-width: 576px) {
            #assignMemberModal .modal-dialog { max-width: 98vw; margin: 0.5rem auto; }
        }
        </style>
                        <div class="assignees-content" id="assigneesContent">
                            <div class="loading-spinner text-center py-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải danh sách thành viên...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Files Tab -->
                <div class="tab-pane" id="filesTab">
                    <div class="files-container">
                        <div class="files-header">
                            <h4>File đính kèm</h4>
                            <div class="files-actions">
                                <button class="btn btn-primary btn-sm" onclick="uploadFile()" id="uploadFileBtn">
                                    <i class="bi bi-cloud-upload me-2"></i>Tải lên file
                                </button>
                            </div>
                        </div>
                        <div class="files-content" id="filesContent">
                            <div class="loading-spinner text-center py-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải danh sách file...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-pane" id="activityTab">
                    <div class="activity-container">
                        <div class="activity-header">
                            <h4>Lịch sử hoạt động</h4>
                        </div>
                        <div class="activity-content" id="activityContent">
                            <div class="loading-spinner text-center py-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải lịch sử hoạt động...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane" id="settingsTab">
                    <div class="settings-container">
                        <div class="settings-header">
                            <h4>Cài đặt nhiệm vụ</h4>
                            <p class="text-muted">Chỉ người tạo nhiệm vụ, LEADER hoặc VICE_LEADER mới có thể thay đổi cài đặt này.</p>
                        </div>
                        <div class="settings-content" id="settingsContent">
                            <!-- Basic Information Section -->
                            <div class="settings-section">
                                <h5><i class="bi bi-info-circle me-2"></i>Thông tin cơ bản</h5>
                                <form id="taskBasicForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Tên nhiệm vụ</label>
                                            <input type="text" class="form-control" id="editTaskTitle" placeholder="Nhập tên nhiệm vụ">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Độ ưu tiên</label>
                                            <select class="form-select" id="editTaskPriority">
                                                <option value="LOW">Thấp</option>
                                                <option value="MEDIUM">Trung bình</option>
                                                <option value="HIGH">Cao</option>
                                                <option value="URGENT">Khẩn cấp</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Trạng thái</label>
                                            <select class="form-select" id="editTaskStatus">
                                                <option value="NOT_STARTED">Chưa bắt đầu</option>
                                                <option value="IN_PROGRESS">Đang thực hiện</option>
                                                <option value="ON_HOLD">Tạm dừng</option>
                                                <option value="COMPLETED">Đã hoàn thành</option>
                                                <option value="CANCELED">Đã hủy</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Deadline</label>
                                            <input type="datetime-local" class="form-control" id="editTaskDeadline">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mô tả</label>
                                        <textarea class="form-control" id="editTaskDescription" rows="3" placeholder="Nhập mô tả nhiệm vụ"></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveTaskBasicInfo()">
                                            <i class="bi bi-check-lg me-2"></i>Lưu thay đổi
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetTaskBasicForm()">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Khôi phục
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Permission Management Section -->
                            <div class="settings-section">
                                <h5><i class="bi bi-shield-check me-2"></i>Quản lý quyền</h5>
                                <div class="permission-controls">
                                    <div class="mb-3">
                                        <label class="form-label">Chuyển quyền sở hữu nhiệm vụ</label>
                                        <div class="input-group">
                                            <select class="form-select" id="newTaskOwner">
                                                <option value="">Chọn thành viên mới...</option>
                                            </select>
                                            <button class="btn btn-warning" onclick="transferTaskOwnership()">
                                                <i class="bi bi-arrow-right me-2"></i>Chuyển quyền
                                            </button>
                                        </div>
                                        <div class="form-text">Chuyển quyền sở hữu nhiệm vụ cho thành viên khác trong dự án.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Danger Zone Section -->
                            <div class="settings-section danger-zone">
                                <h5><i class="bi bi-exclamation-triangle me-2"></i>Vùng nguy hiểm</h5>
                                <div class="danger-actions">
                                    <div class="danger-item">
                                        <div class="danger-info">
                                            <h6>Xóa nhiệm vụ</h6>
                                            <p class="text-muted">Xóa vĩnh viễn nhiệm vụ này và tất cả dữ liệu liên quan. Hành động này không thể hoàn tác.</p>
                                        </div>
                                        <button class="btn btn-danger" onclick="deleteTaskConfirm()">
                                            <i class="bi bi-trash me-2"></i>Xóa nhiệm vụ
                                        </button>
                                    </div>
                                    <div class="danger-item">
                                        <div class="danger-info">
                                            <h6>Archive nhiệm vụ</h6>
                                            <p class="text-muted">Lưu trữ nhiệm vụ này. Nhiệm vụ sẽ được ẩn khỏi danh sách chính nhưng vẫn có thể khôi phục.</p>
                                        </div>
                                        <button class="btn btn-warning" onclick="archiveTask()">
                                            <i class="bi bi-archive me-2"></i>Lưu trữ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- Loading Overlay -->

        <!-- Submit Task Modal -->
        <div class="modal fade" id="submitTaskModal" tabindex="-1" aria-labelledby="submitTaskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="submitTaskModalLabel">Submit nhiệm vụ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                                    <form id="submitTaskForm">
                                        <div class="mb-3">
                                            <label for="submitNote" class="form-label">Ghi chú</label>
                                            <textarea class="form-control" id="submitNote" rows="3" placeholder="Nhập ghi chú (nếu có)"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">File đính kèm</label>
                                            <div class="file-upload-section">
                                                <div class="project-file-preview" id="submitFilePreview" onclick="openSubmitFileDialog()">
                                                    <i class="bi bi-file-earmark-plus upload-icon"></i>
                                                    <p class="upload-text">Nhấn để chọn file đính kèm cho submission</p>
                                                    <small class="text-muted">Có thể chọn nhiều file cùng lúc</small>
                                                    <div class="file-list" id="submitFileList"></div>
                                                </div>
                                                <input type="file" class="d-none" id="submitFiles" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar">
                                                <div class="file-upload-help">
                                                    <small class="text-muted">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        Định dạng hỗ trợ: PDF, Word, Excel, PowerPoint, TXT, ZIP, RAR (tối đa 10MB mỗi file)
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="submitTaskAlert" class="alert d-none" role="alert"></div>
                                    </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-success" id="submitTaskModalBtn">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-3">Đang tải dữ liệu...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Utility Scripts -->
    <script src="/utils/auth-utils.js"></script>
    <script src="/utils/api-client.js"></script>
    <script src="/utils/validation.js"></script>
    <script src="/utils/ui-utils.js"></script>
    
    <!-- Task Details Script -->
    <script src="/js/task-details.js"></script>
</body>
</html>
